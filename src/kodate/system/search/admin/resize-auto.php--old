<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>サムネイル</title>
</head>

<body>
<?php
$resize=array();
$resize['RESIZED']['glob']=glob('../upload-resize/order{*.jpg,*.png,*.gif}',GLOB_BRACE);
//$resize['BASE-IMG']['glob']=glob('../upload/order*-{*.jpg,*.png,*.gif}',GLOB_BRACE);
//print_r($resize);
foreach($resize['RESIZED']['glob'] as $proto){
	$proto=explode('/',$proto);
	$proto=explode('.',end($proto));
	$proto=explode('r',$proto[0]);
	//echo print_r($v,true).'<br>';
	$resize['BASE-IMG']=array();
	$resize['BASE-IMG']['glob']=glob('../upload/order'.end($proto).'-{*.jpg,*.png,*.gif}',GLOB_BRACE);
	//echo print_r($resize['BASE-IMG'],true).'<br>';
	
$resize['BASE-IMG'][0]='';
foreach($resize['BASE-IMG']['glob'] as $v){
	if(strpos($v,'-4.')!==false){
		$resize['BASE-IMG'][4]=$v;
	}
	else if(strpos($v,'-0.')!==false){
		$resize['BASE-IMG'][0]=$v;
	}
}
$resize['BASE-IMG']=isset($resize['BASE-IMG'][4])?$resize['BASE-IMG'][4]:$resize['BASE-IMG'][0];//写真
@chmod($resize['BASE-IMG'], 0666);
echo '<img src="'.print_r($resize['BASE-IMG'],true).'" style="width:3em;">'.print_r($resize['BASE-IMG'],true).'<br>';
//continue;

if($resize['BASE-IMG']!=''){
	$resize['RESIZE-IMG']=str_replace('-','.',$resize['BASE-IMG']);
	$resize['RESIZE-IMG']=explode('.',$resize['RESIZE-IMG']);
	unset($resize['RESIZE-IMG'][count($resize['RESIZE-IMG'])-2]);
	$resize['RESIZE-IMG']=implode('.',$resize['RESIZE-IMG']);
	$resize['RESIZE-IMG']=str_replace('/upload/','/upload-resize/',$resize['RESIZE-IMG']);
	//echo ''.print_r($resize['RESIZE-IMG'],true).'<br>';
	@chmod($resize['RESIZE-IMG'], 0666);
	//continue;
	list($resize['BASE-W'],$resize['BASE-H'],$resize['TYPE'])=getimagesize($resize['BASE-IMG']);
	switch($resize['TYPE']){
		case IMAGETYPE_JPEG:
		$resize['BASE-IMG']=imagecreatefromjpeg($resize['BASE-IMG']);
		break;
		case IMAGETYPE_PNG:
		$resize['BASE-IMG']=imagecreatefrompng($resize['BASE-IMG']);
		break;
		case IMAGETYPE_GIF:
		$resize['BASE-IMG']=imagecreatefromgif($resize['BASE-IMG']);
		break;
		default://未対応
	}
	$resize+=array('MIN-W'=>285,'MIN-H'=>250,'*'=>2);
	$resize['DIV']=$resize['BASE-W']/$resize['MIN-W'];
	$resize['RESIZE-H']=ceil($resize['BASE-H']/$resize['DIV']);
	if($resize['RESIZE-H']<$resize['MIN-H']){
		$resize['DIV']=$resize['BASE-H']/$resize['MIN-H'];
		$resize['RESIZE-W']=ceil($resize['BASE-W']/$resize['DIV'])*$resize['*'];
		$resize['RESIZE-H']=$resize['MIN-H']*$resize['*'];
	}
	else{
		$resize['RESIZE-W']=$resize['MIN-W']*$resize['*'];
		$resize['RESIZE-H']*=$resize['*'];
	}
	$resize['CANVAS']=imagecreatetruecolor($resize['RESIZE-W'],$resize['RESIZE-H']);
	imagecopyresampled($resize['CANVAS'],$resize['BASE-IMG'],0,0,0,0,$resize['RESIZE-W'],$resize['RESIZE-H'],$resize['BASE-W'],$resize['BASE-H']);
	switch($resize['TYPE']){
		case IMAGETYPE_JPEG:
		imagejpeg($resize['CANVAS'],$resize['RESIZE-IMG']);
		break;
		case IMAGETYPE_PNG:
		imagepng($resize['CANVAS'],$resize['RESIZE-IMG'],9);
		break;
		case IMAGETYPE_GIF:
		break;
		imagegif($resize['CANVAS'],$resize['RESIZE-IMG']);
	}
	imagedestroy($resize['CANVAS']);
	//print_r($resize);
	echo '<img src="'.print_r($resize['RESIZE-IMG'],true).'" style="width:3em;">'.print_r($resize['RESIZE-IMG'],true).'<br>';
}
else{
	$resize['DEL']=glob('../upload-resize/order'.$id.'.*');
	if(!empty($resize['DEL'])){
		foreach($resize['DEL'] as $v){
			//古いサムネイル削除
			unlink($v);
		}
	}
}
//unset($resize);



}//foreach($resize['RESIZED']['glob'] as $proto)
?>
</body>
</html>
